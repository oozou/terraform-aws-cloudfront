# AWS VPC Cloudfront Module

Terraform module with create Cloudfront resources on AWS.

```terraform
module "cloudfront" {
  source = "git@github.com:oozou/terraform-aws-cloudfront.git"
  account_alias = "dev"

  prefix = "customer-test"
  name = "app"
  environment = "develop"

  // CDN variables
  origin_config = {
    origin_domain_name = "web.public-hostzone.com"
    origin_id = "web.public-hostzone.com"
  }

  caching_config = {
    forwarded_headers                 = ["Host"]
    forward_cookies                   = "none"
    forward_cookies_whitelisted_names = []
    forward_query_string              = true
    cached_methods                    = ["GET", "HEAD"]
  }

  ttl_config = {
    default_ttl = 30 # seconds
    min_ttl     = 0
    max_ttl     = 60
  }

  //for s3 cloudfront origin
  s3_origin = {
    origin_domain_name = "${module.s3_bucket.bucket_id}.s3.ap-southeast-1.amazonaws.com"
    origin_id = module.s3_bucket.bucket_id
    path_pattern = "/upload/*"
    allowed_methods  = ["GET", "HEAD", "OPTIONS"]
    cached_methods   = ["GET", "HEAD", "OPTIONS"]
    is_create_oai      = true
  }

  log_aggregation_s3_bucket_name = "<bucket>-cloudfront-log"
  custom_header_token  = "test"

  custom_tags       = { Workspace = "100-prefix-pass-app" }


  cdn_certificate_arn = "arn:aws:acm:us-east-1:xxxxxxx:certificate/xxxx-xxxxx-xxxx"
  // DNS Mapping variables
  acm_cert_domain_name = "cdn.public-hostzone.com"
  route53_domain_name  = "public-hostzone.com"

  // Lamdda association in origin-request
  lambda_function_association = {
    event_type   = "origin-request"
    lambda_arn   = "arn:aws:lambda:us-east-1:xxxxxxxxx:function:sigv4-request-to-s3:1"
    include_body = false
  }

  // WAF
  is_enable_waf = true
  is_enable_waf_default_rule = true
  waf_default_action = "allow"
  waf_ip_sets_rule = [
    {
      name               = "count-ip-set"
      priority           = 5
      action             = "count"
      ip_address_version = "IPV4"
      ip_set             = ["1.2.3.4/32", "5.6.7.8/32"]
    },
    {
      name               = "block-ip-set"
      priority           = 6
      action             = "block"
      ip_address_version = "IPV4"
      ip_set             = ["10.0.1.1/32"]
    }
  ]
  waf_ip_rate_based_rule = {
    name : "ip-rate-limit",
    priority : 7,
    action : "block",
    limit : 100
  }
}
```

<!-- BEGIN_TF_DOCS -->

## Requirements

| Name                                                                     | Version  |
| ------------------------------------------------------------------------ | -------- |
| <a name="requirement_terraform"></a> [terraform](#requirement_terraform) | >= 0.13  |
| <a name="requirement_aws"></a> [aws](#requirement_aws)                   | >= 4.0.0 |

## Providers

| Name                                             | Version |
| ------------------------------------------------ | ------- |
| <a name="provider_aws"></a> [aws](#provider_aws) | 4.8.0   |

## Modules

| Name                                         | Source                                     | Version |
| -------------------------------------------- | ------------------------------------------ | ------- |
| <a name="module_waf"></a> [waf](#module_waf) | git@github.com:oozou/terraform-aws-waf.git | develop |

## Resources

| Name                                                                                                                                            | Type        |
| ----------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| [aws_cloudfront_distribution.distribution](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudfront_distribution) | resource    |
| [aws_iam_role.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role)                                       | resource    |
| [aws_iam_role_policy.main](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy)                         | resource    |
| [aws_route53_record.application](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/route53_record)                    | resource    |
| [aws_route53_zone.hosted_zone](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/route53_zone)                     | data source |

## Inputs

| Name                                                                                                                                       | Description                                                                                                                                                                                                                        | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Default                                                                                                                                                                                                                           | Required |
| ------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| <a name="input_account_alias"></a> [account_alias](#input_account_alias)                                                                   | Alias of the AWS account where this service is created. Eg. alpha/beta/prod. This would be used create s3 bucket path in the logging account                                                                                       | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_acm_cert_domain_name"></a> [acm_cert_domain_name](#input_acm_cert_domain_name)                                              | [Required] The FQDN of the certificate to issue (i.e.: 'prime.spike.abc.cloud'). The Route53 zone must already exist.                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_admin_remote_ipset"></a> [admin_remote_ipset](#input_admin_remote_ipset)                                                    | List of IP addresses to whitelist for access to the /admin route. Format of each entry is a map like: { type='IPV4' value='<ip>/32' }                                                                                              | <pre>list(object({<br> type = string<br> value = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                                                                                                              |    no    |
| <a name="input_allowed_methods"></a> [allowed_methods](#input_allowed_methods)                                                             | List of allowed methods (e.g. ` GET, PUT, POST, DELETE, HEAD`) for AWS CloudFront                                                                                                                                                  | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <pre>[<br> "DELETE",<br> "GET",<br> "HEAD",<br> "OPTIONS",<br> "PATCH",<br> "POST",<br> "PUT"<br>]</pre>                                                                                                                          |    no    |
| <a name="input_blacklisted_ips"></a> [blacklisted_ips](#input_blacklisted_ips)                                                             | List of IP addresses to blacklist for access to the application. Format of each entry is a map like: { type='IPV4' value='<ip>/32' }                                                                                               | <pre>list(object({<br> type = string<br> value = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                                                                                                              |    no    |
| <a name="input_caching_config"></a> [caching_config](#input_caching_config)                                                                | Specify CloudFront configuration related to caching behavior                                                                                                                                                                       | <pre>object({<br> forwarded_headers = list(string) # Specifies the Headers, if any, that you want CloudFront to vary upon for the cache behavior. Specify `*` to include all headers. 'none' is not a valid option for HTTPS connection<br> forward_cookies = string # Specifies whether you want CloudFront to forward cookies to the origin. Valid options are all, none or whitelist<br> forward_cookies_whitelisted_names = list(string) # List of forwarded cookie names<br> forward_query_string = bool # Forward query strings to the origin that is associated with this cache behavior<br> cached_methods = list(string) # List of cached methods (e.g. ` GET, PUT, POST, DELETE, HEAD`)<br> })</pre> | <pre>{<br> "cached_methods": [<br> "GET",<br> "HEAD"<br> ],<br> "forward_cookies": "none",<br> "forward_cookies_whitelisted_names": [],<br> "forward_query_string": false,<br> "forwarded_headers": [<br> "Host"<br> ]<br>}</pre> |    no    |
| <a name="input_cdn_certificate_arn"></a> [cdn_certificate_arn](#input_cdn_certificate_arn)                                                 | Specify ARN for CDN certificate                                                                                                                                                                                                    | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_custom_header_token"></a> [custom_header_token](#input_custom_header_token)                                                 | [Required] Specify secret value for custom header                                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_custom_tags"></a> [custom_tags](#input_custom_tags)                                                                         | Custom tags which can be passed on to the AWS resources. They should be key value pairs having distinct keys.                                                                                                                      | `map(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `{}`                                                                                                                                                                                                                              |    no    |
| <a name="input_default_action"></a> [default_action](#input_default_action)                                                                | The default action to take if no rules match (BLOCK, ALLOW, or COUNT)                                                                                                                                                              | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `"BLOCK"`                                                                                                                                                                                                                         |    no    |
| <a name="input_default_root_object"></a> [default_root_object](#input_default_root_object)                                                 | File name for default root object                                                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `"index.html"`                                                                                                                                                                                                                    |    no    |
| <a name="input_domain_aliases"></a> [domain_aliases](#input_domain_aliases)                                                                | Extra CNAMEs (alternate domain names) for the distribution (apart from FQDN for which SSL certificate is issued, it will be added by-default)                                                                                      | `list(string)`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `[]`                                                                                                                                                                                                                              |    no    |
| <a name="input_environment"></a> [environment](#input_environment)                                                                         | [Required] Name prefix used for resource naming in this component                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_geo_restriction_config"></a> [geo_restriction_config](#input_geo_restriction_config)                                        | Specify configuration for restriction based on location                                                                                                                                                                            | <pre>object({<br> geo_restriction_type = string # Method that use to restrict distribution of your content by country: `none`, `whitelist`, or `blacklist<br> geo_restriction_locations = list(string) # List of country codes for which CloudFront either to distribute content (whitelist) or not distribute your content (blacklist)<br> })</pre>                                                                                                                                                                                                                                                                                                                                                           | <pre>{<br> "geo_restriction_locations": [],<br> "geo_restriction_type": "none"<br>}</pre>                                                                                                                                         |    no    |
| <a name="input_is_create_waf_logging_configuration"></a> [is_create_waf_logging_configuration](#input_is_create_waf_logging_configuration) | Whether to create logging configuration in order start logging from a WAFv2 Web ACL to CloudWatch                                                                                                                                  | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`                                                                                                                                                                                                                            |    no    |
| <a name="input_is_enable_waf"></a> [is_enable_waf](#input_is_enable_waf)                                                                   | Whether to enable WAF for CloudFront                                                                                                                                                                                               | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `false`                                                                                                                                                                                                                           |    no    |
| <a name="input_is_enable_waf_cloudwatch_metrics"></a> [is_enable_waf_cloudwatch_metrics](#input_is_enable_waf_cloudwatch_metrics)          | The action to perform if none of the rules contained in the WebACL match.                                                                                                                                                          | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`                                                                                                                                                                                                                            |    no    |
| <a name="input_is_enable_waf_default_rule"></a> [is_enable_waf_default_rule](#input_is_enable_waf_default_rule)                            | If true with enable default rule (detail in locals.tf)                                                                                                                                                                             | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`                                                                                                                                                                                                                            |    no    |
| <a name="input_is_enable_waf_sampled_requests"></a> [is_enable_waf_sampled_requests](#input_is_enable_waf_sampled_requests)                | Whether AWS WAF should store a sampling of the web requests that match the rules. You can view the sampled requests through the AWS WAF console.                                                                                   | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`                                                                                                                                                                                                                            |    no    |
| <a name="input_is_ipv6_enabled"></a> [is_ipv6_enabled](#input_is_ipv6_enabled)                                                             | State of CloudFront IPv6                                                                                                                                                                                                           | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`                                                                                                                                                                                                                            |    no    |
| <a name="input_lambda_function_association"></a> [lambda_function_association](#input_lambda_function_association)                         | The lambda assosiation used with encrypted s3                                                                                                                                                                                      | <pre>object({<br> event_type = string<br> lambda_arn = string<br> include_body = bool<br> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `null`                                                                                                                                                                                                                            |    no    |
| <a name="input_log_aggregation_s3_bucket_name"></a> [log_aggregation_s3_bucket_name](#input_log_aggregation_s3_bucket_name)                | [Required] S3 bucket name where logs are stored for cloudfront                                                                                                                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_log_include_cookies"></a> [log_include_cookies](#input_log_include_cookies)                                                 | Include cookies in access logs                                                                                                                                                                                                     | `bool`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `false`                                                                                                                                                                                                                           |    no    |
| <a name="input_name"></a> [name](#input_name)                                                                                              | [Required] Name prefix used for resource naming in this component                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_origin_config"></a> [origin_config](#input_origin_config)                                                                   | [Required] Specify configuration related to Origin                                                                                                                                                                                 | <pre>object({<br> origin_domain_name = string # Specify domain name for the origin such as a S3 bucket or any web server from which CloudFront is going to get web content<br> origin_id = string # Specify origin id. This value assist in distinguishing multiple origins in the same distribution from one another. Origin id must be unique within the distribution.<br> })</pre>                                                                                                                                                                                                                                                                                                                          | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_origin_read_timeout"></a> [origin_read_timeout](#input_origin_read_timeout)                                                 | Read timeout value specifies the amount of time CloudFront will wait for a response from the custom origin (this should be insync with your origin (like ALB) timeout)                                                             | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `60`                                                                                                                                                                                                                              |    no    |
| <a name="input_prefix"></a> [prefix](#input_prefix)                                                                                        | [Required] Name prefix used for resource naming in this component                                                                                                                                                                  | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_price_class"></a> [price_class](#input_price_class)                                                                         | Price class for this distribution: `PriceClass_All`, `PriceClass_200`, `PriceClass_100` (price class denotes the edge locations which are supported by CDN)                                                                        | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `"PriceClass_100"`                                                                                                                                                                                                                |    no    |
| <a name="input_route53_domain_name"></a> [route53_domain_name](#input_route53_domain_name)                                                 | [Required] The Name of the already existing Route53 Hosted Zone (i.e.: 'spike.abc.cloud')                                                                                                                                          | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | n/a                                                                                                                                                                                                                               |   yes    |
| <a name="input_s3_origin"></a> [s3_origin](#input_s3_origin)                                                                               | Specify configuration related to Origin S3                                                                                                                                                                                         | <pre>object({<br> path_pattern = string<br> allowed_methods = list(string)<br> cached_methods = list(string)<br> origin_domain_name = string<br> origin_id = string<br> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `null`                                                                                                                                                                                                                            |    no    |
| <a name="input_secondary_origin_config"></a> [secondary_origin_config](#input_secondary_origin_config)                                     | Specify configuration related to secondary origin. This origin will be used for high availability with CloudFront primary origin                                                                                                   | <pre>object({<br> secondary_domain_name = string # Specify domain name for the origin such as a S3 bucket or any web server from which CloudFront is going to get web content<br> secondary_origin_id = string # Specify origin id. This value assist in distinguishing multiple origins in the same distribution from one another. Origin id must be unique within the distribution.<br> })</pre>                                                                                                                                                                                                                                                                                                             | `null`                                                                                                                                                                                                                            |    no    |
| <a name="input_ttl_config"></a> [ttl_config](#input_ttl_config)                                                                            | Specify Time To Live (TTL) configuration for CloudFront                                                                                                                                                                            | <pre>object({<br> default_ttl = number #Default amount of time (in seconds) that an object is in a CloudFront cache, after this time CDN makes a fresh call to origin<br> min_ttl = number #Minimum amount of time that you want objects to stay in CloudFront caches<br> max_ttl = number #Maximum amount of time (in seconds) that an object is in a CloudFront cache<br> })</pre>                                                                                                                                                                                                                                                                                                                           | <pre>{<br> "default_ttl": 3600,<br> "max_ttl": 86400,<br> "min_ttl": 0<br>}</pre>                                                                                                                                                 |    no    |
| <a name="input_waf_default_action"></a> [waf_default_action](#input_waf_default_action)                                                    | The action to perform if none of the rules contained in the WebACL match.                                                                                                                                                          | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `"block"`                                                                                                                                                                                                                         |    no    |
| <a name="input_waf_ip_rate_based_rule"></a> [waf_ip_rate_based_rule](#input_waf_ip_rate_based_rule)                                        | A rate-based rule tracks the rate of requests for each originating IP address, and triggers the rule action when the rate exceeds a limit that you specify on the number of requests in any 5-minute time span                     | <pre>object({<br> name = string<br> priority = number<br> action = string<br> limit = number<br> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `null`                                                                                                                                                                                                                            |    no    |
| <a name="input_waf_ip_sets_rule"></a> [waf_ip_sets_rule](#input_waf_ip_sets_rule)                                                          | A rule to detect web requests coming from particular IP addresses or address ranges.                                                                                                                                               | <pre>list(object({<br> name = string<br> priority = number<br> ip_set = list(string)<br> action = string<br> ip_address_version = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `[]`                                                                                                                                                                                                                              |    no    |
| <a name="input_waf_logging_filter"></a> [waf_logging_filter](#input_waf_logging_filter)                                                    | A configuration block that specifies which web requests are kept in the logs and which are dropped. You can filter on the rule action and on the web request labels that were applied by matching rules during web ACL evaluation. | `any`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `{}`                                                                                                                                                                                                                              |    no    |
| <a name="input_waf_managed_rules"></a> [waf_managed_rules](#input_waf_managed_rules)                                                       | List of Managed WAF rules.                                                                                                                                                                                                         | <pre>list(object({<br> name = string<br> priority = number<br> override_action = string<br> excluded_rules = list(string)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `[]`                                                                                                                                                                                                                              |    no    |
| <a name="input_waf_redacted_fields"></a> [waf_redacted_fields](#input_waf_redacted_fields)                                                 | The parts of the request that you want to keep out of the logs. Up to 100 `redacted_fields` blocks are supported.                                                                                                                  | `any`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                                                                                                              |    no    |
| <a name="input_whitelisted_ips"></a> [whitelisted_ips](#input_whitelisted_ips)                                                             | List of IP addresses to whitelist for access to the application. Format of each entry is a map like: { type='IPV4' value='<ip>/32' }                                                                                               | <pre>list(object({<br> type = string<br> value = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `[]`                                                                                                                                                                                                                              |    no    |

## Outputs

No outputs.

<!-- END_TF_DOCS -->
